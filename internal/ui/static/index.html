<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mcpenetes Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        .container { max-width: 1200px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .card { padding: 1rem; border: 1px solid var(--muted-border-color); border-radius: var(--border-radius); }
        .success { color: var(--ins-color); }
        .error { color: var(--del-color); }
        .warning { color: var(--pico-color-amber-500); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal { display: none; }
        .modal[open] { display: block; }
    </style>
</head>
<body>
    <main class="container">
        <nav>
            <ul>
                <li><strong>üßô‚Äç‚ôÇÔ∏è mcpenetes</strong> <small id="versionDisplay"></small></li>
            </ul>
            <ul>
                <li><a href="#" onclick="switchTab('dashboard')" title="View clients and servers">Dashboard</a></li>
                <li><a href="#" onclick="switchTab('search')" title="Find new MCP servers">Search & Install</a></li>
                <li><a href="#" onclick="switchTab('registries')" title="Manage server registries">Registries</a></li>
                <li><a href="#" onclick="switchTab('backups'); loadBackups()" title="Restore previous configs">Backups</a></li>
                <li><a href="#" onclick="switchTab('help')" title="View documentation">Help</a></li>
                <li><a href="#" onclick="loadData(); checkDoctor();" title="Reload configuration and run health checks">Refresh</a></li>
            </ul>
        </nav>

        <!-- Doctor Status Banner -->
        <div id="doctorBanner" style="display:none; margin-bottom: 1rem; padding: 0.5rem; border-radius: var(--border-radius); background-color: var(--card-background-color); border: 1px solid var(--muted-border-color);">
            <details>
                <summary id="doctorSummary">System Status: Checking...</summary>
                <ul id="doctorList" style="margin-top: 0.5rem;"></ul>
            </details>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="grid">
                <!-- Detected Clients -->
                <section>
                    <h3>Detected Clients</h3>
                    <p>Select clients to apply MCP configurations to.</p>
                    <div class="card">
                        <form id="clientsForm">
                            <div id="clientsList">Loading...</div>
                        </form>
                    </div>
                </section>

                <!-- Configured MCP Servers -->
                <section>
                    <h3>Configured MCP Servers</h3>
                    <p>These servers will be installed on selected clients.</p>
                    <div class="card">
                        <div id="serversList">Loading...</div>
                    </div>
                </section>
            </div>

            <hr>

            <!-- Actions -->
            <section>
                <h3>Actions</h3>
                <div class="grid">
                    <div>
                        <button onclick="applyConfig()" id="applyBtn" title="Write configuration to selected clients">Apply Configuration to Selected Clients</button>
                    </div>
                    <div>
                        <button class="secondary" onclick="openImportModal()" title="Load configuration from JSON">Import Config from JSON</button>
                    </div>
                </div>
                <div id="resultArea"></div>
            </section>
        </div>

        <!-- Search Tab -->
        <div id="search" class="tab-content">
            <section>
                <h3>Search MCP Registry</h3>
                <p>Find and install new MCP servers from configured registries.</p>
                <div class="grid">
                    <div>
                        <input type="search" id="searchInput" placeholder="Search for MCP servers..." onkeyup="if(event.key === 'Enter') searchServers()" title="Enter keywords like 'postgres', 'git', etc.">
                    </div>
                    <div>
                        <button onclick="searchServers()" id="searchBtn" title="Execute search">Search</button>
                    </div>
                </div>
                <div id="searchResults" class="card"></div>
            </section>
        </div>

        <!-- Registries Tab -->
        <div id="registries" class="tab-content">
            <section>
                <h3>Configured Registries</h3>
                <p>Sources for MCP server definitions.</p>
                <div class="card">
                    <div id="registriesList">Loading...</div>
                </div>
                <hr>
                <h4>Add Registry</h4>
                <div class="grid">
                    <div><input type="text" id="newRegName" placeholder="Name (e.g. My Registry)" title="Friendly name for the registry"></div>
                    <div><input type="url" id="newRegUrl" placeholder="URL (e.g. https://...)" title="URL of the registry JSON"></div>
                    <div><button onclick="addRegistry()" title="Add new registry source">Add</button></div>
                </div>
            </section>
        </div>

        <!-- Backups Tab -->
        <div id="backups" class="tab-content">
            <section>
                <h3>Client Backups</h3>
                <p>Restore previous configurations for your clients. Backups are created automatically before applying changes.</p>
                <div class="card">
                    <div id="backupsList">Loading...</div>
                </div>
            </section>
        </div>

        <!-- Help Tab -->
        <div id="help" class="tab-content">
            <section>
                <h2>Help & Documentation</h2>
                <div class="card">
                    <details open>
                        <summary><strong>Getting Started</strong></summary>
                        <p>Welcome to <strong>mcpenetes</strong>, the configuration manager for Model Context Protocol (MCP) servers.</p>
                        <ol>
                            <li><strong>Detected Clients:</strong> Check the "Dashboard" to see which MCP-compatible tools (VS Code, Claude, etc.) were detected on your system.</li>
                            <li><strong>Add Servers:</strong> Use the "Search & Install" tab to find servers like Postgres, Git, or Google Drive.</li>
                            <li><strong>Apply Config:</strong> Click "Apply Configuration" on the Dashboard to write the MCP settings to your selected clients.</li>
                        </ol>
                    </details>

                    <details>
                        <summary><strong>Managing Servers</strong></summary>
                        <p>In the "Configured MCP Servers" list on the Dashboard:</p>
                        <ul>
                            <li><strong>Inspect:</strong> Generates a command to test the server with the MCP Inspector.</li>
                            <li><strong>Edit:</strong> Allows you to modify the server command, arguments, and environment variables directly.</li>
                            <li><strong>Delete:</strong> Removes the server from your configuration.</li>
                        </ul>
                    </details>

                    <details>
                        <summary><strong>Importing Configuration</strong></summary>
                        <p>If you have an existing <code>mcpServers</code> JSON configuration (e.g., from a friend or documentation), you can use the <strong>Import Config</strong> button on the Dashboard. Paste the JSON, and it will be merged into your configuration.</p>
                    </details>

                    <details>
                        <summary><strong>Backups & Restore</strong></summary>
                        <p>Every time you click "Apply", mcpenetes creates a backup of your client's existing configuration file.</p>
                        <p>Go to the <strong>Backups</strong> tab to view history and restore previous versions if something goes wrong.</p>
                    </details>

                    <details>
                        <summary><strong>Troubleshooting</strong></summary>
                        <p>The system status bar at the top ("Doctor") shows health checks.</p>
                        <ul>
                            <li><strong>Errors (‚ùå):</strong> Critical issues preventing functionality (e.g., missing <code>npx</code>).</li>
                            <li><strong>Warnings (‚ö†Ô∏è):</strong> Potential issues (e.g., missing config files for some clients).</li>
                        </ul>
                    </details>
                </div>
            </section>
        </div>
    </main>

    <!-- Edit/Install Server Modal -->
    <dialog id="editModal">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close" onclick="closeEditModal()"></a>
                <span id="modalTitle">Edit Server Configuration</span>
            </header>
            <form id="editForm">
                <input type="hidden" id="editServerID">
                <input type="hidden" id="editMode" value="edit"> <!-- 'edit' or 'install' -->

                <label for="editConfigJSON">Configuration (JSON)</label>
                <textarea id="editConfigJSON" rows="10" style="font-family: monospace;"></textarea>
                <small>For installation, customize the command and arguments below. Commonly <code>npx -y package-name</code> or <code>uvx package-name</code>.</small>
            </form>
            <footer>
                <a href="#" role="button" class="secondary" onclick="closeEditModal()">Cancel</a>
                <a href="#" role="button" onclick="saveServerConfig()">Save / Install</a>
            </footer>
        </article>
    </dialog>

    <!-- Import Modal -->
    <dialog id="importModal">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close" onclick="closeImportModal()"></a>
                <h3>Import Configuration</h3>
            </header>
            <p>Paste your MCP configuration JSON below (e.g., from clipboard). It should contain <code>"mcpServers"</code>.</p>
            <textarea id="importJSON" rows="10" style="font-family: monospace;" placeholder='{"mcpServers": { "my-server": { "command": "npx", "args": ["-y", "my-server"] } }}'></textarea>
            <footer>
                <a href="#" role="button" class="secondary" onclick="closeImportModal()">Cancel</a>
                <a href="#" role="button" onclick="importConfig()">Import</a>
            </footer>
        </article>
    </dialog>

    <script>
        let configData = null;

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        async function loadData() {
            try {
                const res = await fetch('/api/data');
                configData = await res.json();

                if (configData.version) {
                    document.getElementById('versionDisplay').innerText = `v${configData.version}`;
                }

                renderClients();
                renderServers();
                renderRegistries();
            } catch (e) {
                console.error(e);
                document.getElementById('clientsList').innerHTML = `<span class="error">Error loading data: ${e}</span>`;
            }
        }

        async function checkDoctor() {
            try {
                const res = await fetch('/api/doctor');
                const results = await res.json();

                const banner = document.getElementById('doctorBanner');
                const summary = document.getElementById('doctorSummary');
                const list = document.getElementById('doctorList');

                banner.style.display = 'block';
                list.innerHTML = '';

                let errorCount = 0;
                let warningCount = 0;

                results.forEach(r => {
                    let icon = '‚úÖ';
                    let cls = 'success';
                    if (r.status === 'error') {
                        icon = '‚ùå';
                        cls = 'error';
                        errorCount++;
                    } else if (r.status === 'warning') {
                        icon = '‚ö†Ô∏è';
                        cls = 'warning';
                        warningCount++;
                    }

                    list.innerHTML += `<li class="${cls}">${icon} <strong>${r.name}</strong>: ${r.message}</li>`;
                });

                if (errorCount > 0) {
                    summary.innerHTML = `System Status: <span class="error">‚ùå ${errorCount} Errors</span>, <span class="warning">${warningCount} Warnings</span>`;
                } else if (warningCount > 0) {
                    summary.innerHTML = `System Status: <span class="warning">‚ö†Ô∏è ${warningCount} Warnings</span>`;
                } else {
                    summary.innerHTML = `System Status: <span class="success">‚úÖ All Systems Operational</span>`;
                }

            } catch (e) {
                console.error("Doctor check failed", e);
            }
        }

        function renderClients() {
            const list = document.getElementById('clientsList');
            if (!configData.clients || Object.keys(configData.clients).length === 0) {
                list.innerHTML = "No clients detected.";
                return;
            }

            let html = '';
            for (const [name, client] of Object.entries(configData.clients)) {
                html += `
                    <label>
                        <input type="checkbox" name="client" value="${name}" checked>
                        ${name} <small>(${client.config_path})</small>
                    </label>
                `;
            }
            list.innerHTML = html;
        }

        function renderServers() {
            const list = document.getElementById('serversList');
            if (!configData.mcpServers || Object.keys(configData.mcpServers).length === 0) {
                list.innerHTML = "No servers configured.";
                return;
            }

            let html = '<ul>';
            for (const [name, server] of Object.entries(configData.mcpServers)) {
                let details = server.url ? `URL: ${server.url}` : `Command: ${server.command} ${server.args ? server.args.join(' ') : ''}`;
                html += `
                    <li style="margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1; margin-right: 1rem;">
                                <strong>${name}</strong>: ${details}
                            </div>
                            <div style="flex-shrink: 0;">
                                <button class="outline small" style="width: auto; padding: 0.25rem 0.5rem; margin-right: 0.5rem;" onclick="inspectServer('${name}')" title="Generate inspection command">üîç Inspect</button>
                                <button class="outline small" style="width: auto; padding: 0.25rem 0.5rem; margin-right: 0.5rem;" onclick="openEditModal('${name}')" title="Edit server config">Edit</button>
                                <button class="outline small error" style="width: auto; padding: 0.25rem 0.5rem; color: var(--del-color); border-color: var(--del-color);" onclick="deleteServer('${name}')" title="Delete server">Delete</button>
                            </div>
                        </div>
                    </li>`;
            }
            html += '</ul>';
            list.innerHTML = html;
        }

        function renderRegistries() {
            const list = document.getElementById('registriesList');
            if (!configData.registries || configData.registries.length === 0) {
                list.innerHTML = "No registries configured.";
                return;
            }

            let html = '<ul>';
            configData.registries.forEach(reg => {
                html += `
                    <li style="margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div><strong>${reg.name}</strong>: ${reg.url}</div>
                            <button class="outline small error" style="width: auto; padding: 0.25rem 0.5rem; color: var(--del-color); border-color: var(--del-color);" onclick="removeRegistry('${reg.name}')" title="Remove registry">Remove</button>
                        </div>
                    </li>`;
            });
            html += '</ul>';
            list.innerHTML = html;
        }

        async function addRegistry() {
            const name = document.getElementById('newRegName').value;
            const url = document.getElementById('newRegUrl').value;

            if (!name || !url) {
                alert("Name and URL are required");
                return;
            }

            try {
                const res = await fetch('/api/registry/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, url})
                });

                if (res.ok) {
                    document.getElementById('newRegName').value = '';
                    document.getElementById('newRegUrl').value = '';
                    loadData();
                } else {
                    const err = await res.text();
                    alert("Failed to add registry: " + err);
                }
            } catch (e) {
                alert("Error: " + e);
            }
        }

        async function removeRegistry(name) {
            if (!confirm(`Remove registry '${name}'?`)) return;

            try {
                const res = await fetch('/api/registry/remove', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name})
                });

                if (res.ok) {
                    loadData();
                } else {
                    const err = await res.text();
                    alert("Failed to remove registry: " + err);
                }
            } catch (e) {
                alert("Error: " + e);
            }
        }

        function openEditModal(serverID) {
            const server = configData.mcpServers[serverID];
            if (!server) return;

            document.getElementById('editServerID').value = serverID;
            document.getElementById('editMode').value = 'edit';
            document.getElementById('modalTitle').innerText = `Edit ${serverID}`;

            // Pretty print JSON for editing
            document.getElementById('editConfigJSON').value = JSON.stringify(server, null, 2);
            document.getElementById('editModal').setAttribute('open', 'true');
        }

        function openInstallModal(serverID) {
            document.getElementById('editServerID').value = serverID;
            document.getElementById('editMode').value = 'install';
            document.getElementById('modalTitle').innerText = `Install ${serverID}`;

            // Default install config template
            const defaultConfig = {
                command: "npx",
                args: ["-y", serverID],
                env: {}
            };

            document.getElementById('editConfigJSON').value = JSON.stringify(defaultConfig, null, 2);
            document.getElementById('editModal').setAttribute('open', 'true');
        }

        function closeEditModal() {
            document.getElementById('editModal').removeAttribute('open');
        }

        async function saveServerConfig() {
            const serverID = document.getElementById('editServerID').value;
            const mode = document.getElementById('editMode').value;
            const jsonStr = document.getElementById('editConfigJSON').value;
            let configObj;

            try {
                configObj = JSON.parse(jsonStr);
            } catch (e) {
                alert("Invalid JSON: " + e);
                return;
            }

            try {
                let url = '/api/server/update';
                let body = {
                    serverId: serverID,
                    config: configObj
                };

                if (mode === 'install') {
                    url = '/api/install';
                    // install endpoint expects {serverId, config} structure now too
                }

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    closeEditModal();
                    alert(mode === 'install' ? "Server installed!" : "Configuration saved!");
                    loadData(); // Refresh list
                    if (mode === 'install') {
                        switchTab('dashboard');
                    }
                } else {
                    const err = await res.text();
                    alert("Failed: " + err);
                }
            } catch (e) {
                alert("Error: " + e);
            }
        }

        async function deleteServer(serverID) {
            if (!confirm(`Are you sure you want to delete server '${serverID}'? This cannot be undone.`)) {
                return;
            }

            try {
                const res = await fetch('/api/server/remove', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({serverId: serverID})
                });

                if (res.ok) {
                    // alert("Server removed!"); // Optional feedback
                    loadData(); // Refresh list
                } else {
                    const err = await res.text();
                    alert("Failed to delete: " + err);
                }
            } catch (e) {
                alert("Error deleting server: " + e);
            }
        }

        async function inspectServer(serverID) {
            const server = configData.mcpServers[serverID];
            if (!server) return;

            try {
                const res = await fetch('/api/server/inspect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({serverId: serverID, config: server})
                });

                const data = await res.json();
                if (data.status === 'success') {
                    // Create a temporary modal or alert with the command
                    // Using a prompt allows easy copying
                    prompt(data.message, data.command);
                } else {
                    alert("Failed to get inspection command.");
                }
            } catch (e) {
                alert("Error: " + e);
            }
        }

        async function applyConfig() {
            const btn = document.getElementById('applyBtn');
            const resultArea = document.getElementById('resultArea');
            btn.setAttribute('aria-busy', 'true');
            resultArea.innerHTML = '';

            const selected = [];
            document.querySelectorAll('input[name="client"]:checked').forEach(el => {
                selected.push(el.value);
            });

            if (selected.length === 0) {
                alert("Please select at least one client.");
                btn.setAttribute('aria-busy', 'false');
                return;
            }

            try {
                const res = await fetch('/api/apply', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({clients: selected})
                });
                const data = await res.json();

                let html = '<h4>Results</h4><ul>';
                for (const res of data.results) {
                    if (res.success) {
                        html += `<li class="success">‚úÖ ${res.clientName}: Success (Backup: ${res.backupPath})</li>`;
                    } else {
                        html += `<li class="error">‚ùå ${res.clientName}: Failed - ${res.error}</li>`;
                    }
                }
                html += '</ul>';
                resultArea.innerHTML = html;
                loadData(); // Refresh lists

            } catch (e) {
                resultArea.innerHTML = `<span class="error">Request failed: ${e}</span>`;
            } finally {
                btn.setAttribute('aria-busy', 'false');
            }
        }

        async function searchServers() {
            const query = document.getElementById('searchInput').value;
            const btn = document.getElementById('searchBtn');
            const resultArea = document.getElementById('searchResults');

            btn.setAttribute('aria-busy', 'true');
            resultArea.innerHTML = 'Searching...';

            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const servers = await res.json();

                if (!servers || servers.length === 0) {
                    resultArea.innerHTML = 'No servers found.';
                    return;
                }

                let html = '<table><thead><tr><th>Name</th><th>Description</th><th>Action</th></tr></thead><tbody>';
                for (const s of servers) {
                    html += `
                        <tr>
                            <td><strong>${s.Name}</strong></td>
                            <td>${s.Description}</td>
                            <td>
                                <button onclick="openInstallModal('${s.Name}')" class="secondary outline">Install</button>
                                ${s.RepositoryURL ? `<a href="${s.RepositoryURL}" target="_blank" role="button" class="outline">View Repo</a>` : ''}
                            </td>
                        </tr>
                    `;
                }
                html += '</tbody></table>';
                resultArea.innerHTML = html;

            } catch (e) {
                resultArea.innerHTML = `<span class="error">Search failed: ${e}</span>`;
            } finally {
                btn.setAttribute('aria-busy', 'false');
            }
        }

        async function loadBackups() {
            const list = document.getElementById('backupsList');
            list.innerHTML = 'Loading...';

            try {
                const res = await fetch('/api/backups');
                const backups = await res.json();

                if (!backups || Object.keys(backups).length === 0) {
                    list.innerHTML = "No backups found.";
                    return;
                }

                let html = '';
                for (const [clientName, files] of Object.entries(backups)) {
                    html += `<details open><summary><strong>${clientName}</strong> (${files.length})</summary><ul>`;
                    for (const file of files) {
                        const date = new Date(file.timestamp).toLocaleString();
                        html += `
                            <li style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <span>${file.name} <small>(${date})</small></span>
                                <button class="outline small warning" style="width: auto; padding: 0.25rem 0.5rem;" onclick="restoreBackup('${clientName}', '${file.name}')">Restore</button>
                            </li>`;
                    }
                    html += '</ul></details>';
                }
                list.innerHTML = html;
            } catch (e) {
                list.innerHTML = `<span class="error">Error loading backups: ${e}</span>`;
            }
        }

        async function restoreBackup(clientName, fileName) {
            if (!confirm(`Are you sure you want to restore '${fileName}' for ${clientName}? Current configuration will be overwritten.`)) {
                return;
            }

            try {
                const res = await fetch('/api/restore', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({client: clientName, file: fileName})
                });

                const data = await res.json();
                if (res.ok) {
                    alert(data.message);
                } else {
                    alert("Failed: " + data.message);
                }
            } catch (e) {
                alert("Error: " + e);
            }
        }

        function openImportModal() {
            document.getElementById('importModal').setAttribute('open', 'true');
        }

        function closeImportModal() {
            document.getElementById('importModal').removeAttribute('open');
            document.getElementById('importJSON').value = '';
        }

        async function importConfig() {
            const configStr = document.getElementById('importJSON').value;
            if (!configStr) {
                alert("Please paste configuration content.");
                return;
            }

            try {
                const res = await fetch('/api/import', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({config: configStr})
                });

                const data = await res.json();
                if (res.ok) {
                    alert(data.message);
                    closeImportModal();
                    loadData(); // Refresh
                } else {
                    alert("Import failed: " + data.message);
                }
            } catch (e) {
                alert("Error: " + e);
            }
        }

        // Initial Load
        loadData();
        checkDoctor(); // Load health status
    </script>
</body>
</html>
