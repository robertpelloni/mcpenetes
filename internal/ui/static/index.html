<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mcpenetes Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        .container { max-width: 1200px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .card { padding: 1rem; border: 1px solid var(--muted-border-color); border-radius: var(--border-radius); }
        .success { color: var(--ins-color); }
        .error { color: var(--del-color); }
        .warning { color: var(--pico-color-amber-500); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal { display: none; }
        .modal[open] { display: block; }
    </style>
</head>
<body>
    <main class="container">
        <nav>
            <ul>
                <li><strong>üßô‚Äç‚ôÇÔ∏è mcpenetes</strong> <small id="versionDisplay"></small></li>
            </ul>
            <ul>
                <li><a href="#" onclick="switchTab('dashboard')">Dashboard</a></li>
                <li><a href="#" onclick="switchTab('search')">Search & Install</a></li>
                <li><a href="#" onclick="switchTab('registries')">Registries</a></li>
                <li><a href="#" onclick="switchTab('clients')">Clients</a></li>
                <li><a href="#" onclick="switchTab('backups')">Backups</a></li>
                <li><a href="#" onclick="switchTab('logs')">Logs</a></li>
                <li><a href="#" onclick="switchTab('system')">System</a></li>
                <li><a href="#" onclick="switchTab('settings')">Settings</a></li>
                <li><a href="#" onclick="switchTab('sync')">Cloud Sync</a></li>
                <li><a href="#" onclick="switchTab('help')">Help</a></li>
                <li><a href="#" onclick="openImportModal()">Import</a></li>
                <li><a href="#" onclick="loadData(); checkDoctor();">Refresh</a></li>
            </ul>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="grid">
                <!-- Detected Clients -->
                <section>
                    <h3>Detected Clients</h3>
                    <div class="card">
                        <form id="clientsForm">
                            <div id="clientsList">Loading...</div>
                        </form>
                    </div>
                </section>

                <!-- Configured MCP Servers -->
                <section>
                    <h3>Configured MCP Servers</h3>
                    <div class="card">
                        <div id="serversList">Loading...</div>
                    </div>
                </section>
            </div>

            <hr>

            <!-- Actions -->
            <section>
                <h3>Actions</h3>
                <button onclick="applyConfig()" id="applyBtn">Apply Configuration to Selected Clients</button>
                <div id="resultArea"></div>
            </section>
        </div>

        <!-- Search Tab -->
        <div id="search" class="tab-content">
            <section>
                <h3>Search MCP Registry</h3>
                <div class="grid">
                    <div>
                        <input type="search" id="searchInput" placeholder="Search for MCP servers..." onkeyup="if(event.key === 'Enter') searchServers()">
                    </div>
                    <div>
                        <button onclick="searchServers()" id="searchBtn">Search</button>
                    </div>
                </div>
                <div id="searchResults" class="card"></div>
            </section>
        </div>

        <!-- Registries Tab -->
        <div id="registries" class="tab-content">
            <section>
                <h3>Configured Registries</h3>
                <div class="card">
                    <div id="registriesList">Loading...</div>
                </div>
                <hr>
                <h4>Add Registry</h4>
                <div class="grid">
                    <div><input type="text" id="newRegName" placeholder="Name (e.g. My Registry)"></div>
                    <div><input type="url" id="newRegUrl" placeholder="URL (e.g. https://...)"></div>
                    <div><button onclick="addRegistry()">Add</button></div>
                </div>
            </section>
        </div>

        <!-- Clients Tab -->
        <div id="clients" class="tab-content">
            <section>
                <h3>Known Clients</h3>
                <p>These clients are supported out-of-the-box. If one is not detected, you can configure it manually below.</p>
                <div class="card">
                    <div id="knownClientsList">Loading...</div>
                </div>
            </section>
            <hr>
            <section>
                <h3>Custom Clients</h3>
                <div class="card">
                    <div id="customClientsList">Loading...</div>
                </div>
                <hr>
                <h4>Add / Configure Client</h4>
                <div class="grid">
                    <div>
                        <label>ID</label>
                        <input type="text" id="newClientID" placeholder="e.g. my-tool">
                    </div>
                    <div>
                        <label>Name</label>
                        <input type="text" id="newClientName" placeholder="e.g. My Tool">
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label>Config Format</label>
                        <select id="newClientFormat">
                            <option value="simple-json">Simple JSON (mcpServers)</option>
                            <option value="vscode">VS Code (mcp.servers)</option>
                            <option value="claude-desktop">Claude Desktop</option>
                            <option value="yaml">YAML</option>
                            <option value="toml">TOML</option>
                        </select>
                    </div>
                    <div>
                        <label>Config Key (Optional)</label>
                        <input type="text" id="newClientConfigKey" placeholder="e.g. openctx.providers">
                        <small>Override the default JSON key (e.g. for VS Code extensions).</small>
                    </div>
                    <div>
                        <label>Base Directory</label>
                        <select id="newClientBase">
                            <option value="home">Home Directory (~/)</option>
                            <option value="appdata">AppData / .config</option>
                            <option value="userprofile">UserProfile</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label>Relative Path</label>
                    <input type="text" id="newClientPath" placeholder="e.g. .config/tool/config.json">
                </div>
                <button onclick="addCustomClient()">Add Client</button>
            </section>
        </div>

        <!-- Backups Tab -->
        <div id="backups" class="tab-content">
            <section>
                <h3>Configuration Backups</h3>
                <p>Restore previous configurations if something goes wrong.</p>
                <div class="card">
                    <div id="backupsList">Loading...</div>
                </div>
            </section>
        </div>

        <!-- Logs Tab -->
        <div id="logs" class="tab-content">
            <section>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3>Application Logs</h3>
                    <div>
                        <input type="text" id="logFilter" placeholder="Filter logs..." onkeyup="filterLogs()" style="display: inline-block; width: auto; margin-right: 0.5rem;" title="Type to filter log messages">
                        <button onclick="clearLogs()" class="outline error" title="Clear all application logs">Clear Logs</button>
                    </div>
                </div>

                <div class="card" style="background: #1e1e1e; color: #d4d4d4; padding: 1rem; height: 500px; overflow-y: auto; font-family: monospace; white-space: pre-wrap;" id="logsContainer">
                    Loading logs...
                </div>
                <button onclick="loadLogs()" class="secondary outline" style="margin-top: 1rem;">Refresh Logs</button>
            </section>
        </div>

        <!-- Help Tab -->

        <!-- System Tab -->

        <div id="system" class="tab-content">
            <section>
                <h3>System Health (Doctor)</h3>
                <div class="card" id="systemDoctorReport">
                    Checking health...
                </div>
            </section>

            <section>
                <h3>System Information</h3>
                <div class="grid">
                    <div class="card">
                        <header>Build Info</header>
                        <ul>
                            <li><strong>App Version:</strong> <span id="sysAppVersion">Loading...</span></li>
                            <li><strong>Go Version:</strong> <span id="sysGoVersion">Loading...</span></li>
                            <li><strong>OS/Arch:</strong> <span id="sysOS">Loading...</span></li>
                        </ul>
                    </div>
                    <div class="card">
                         <header>Submodules</header>
                         <div id="sysSubmodules">None detected.</div>
                    </div>
                </div>
                <hr>
                <h4>Project Structure</h4>
                <div class="card">
                    <pre id="sysStructure" style="background:none; border:none; padding:0; margin:0;">Loading...</pre>
                </div>
            </section>
        </div>

        <div id="sync" class="tab-content">
            <section>
                <h3>Cloud Synchronization (GitHub Gist)</h3>
                <p>Sync your configuration across multiple machines using a private GitHub Gist.</p>

                <div id="syncUnlinked" style="display:none;">
                    <div class="card">
                        <h4>Connect to GitHub</h4>
                        <label for="githubToken">GitHub Personal Access Token (PAT)</label>
                        <input type="password" id="githubToken" placeholder="ghp_...">
                        <small>Token needs <code>gist</code> scope.</small>
                        <button onclick="setupSync()">Link GitHub Account</button>
                    </div>
                </div>

                <div id="syncLinked" style="display:none;">
                    <div class="grid">
                        <div class="card">
                            <h4>Status</h4>
                            <ul>
                                <li><strong>Status:</strong> <span class="success">‚úÖ Linked</span></li>
                                <li><strong>Gist ID:</strong> <span id="syncGistID">Loading...</span></li>
                                <li><strong>Last Synced:</strong> <span id="syncLastTime">Never</span></li>
                            </ul>
                        </div>
                        <div class="card">
                            <h4>Actions</h4>
                            <div class="grid">
                                <button onclick="syncPush()" class="outline">‚òÅÔ∏è Push to Cloud</button>
                                <button onclick="syncPull()" class="outline">üì• Pull from Cloud</button>
                            </div>
                            <small>Push uploads your local config. Pull overwrites local config (after backup).</small>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div id="settings" class="tab-content">
            <section>
                <h3>Global Settings</h3>
                <div class="card">
                    <div class="grid">
                        <div>
                            <label for="settingBackupPath">Backup Storage Path</label>
                            <input type="text" id="settingBackupPath" placeholder="~/.config/mcpetes/backups">
                            <small>Directory where configuration backups are stored.</small>
                        </div>
                        <div>
                            <label for="settingBackupRetention">Retention Policy (Max Backups)</label>
                            <input type="number" id="settingBackupRetention" placeholder="5" min="1">
                            <small>Number of backups to keep per client. Older backups are deleted automatically.</small>
                        </div>
                    </div>
                    <hr>
                    <h4>Global Environment Variables</h4>
                    <p>These variables will be injected into every server configuration unless overridden by server-specific settings.</p>
                    <div id="globalEnvContainer">
                        <div class="grid" style="margin-bottom: 0.5rem;">
                            <input type="text" placeholder="Key (e.g. OPENAI_API_KEY)" class="env-key">
                            <input type="text" placeholder="Value" class="env-value">
                        </div>
                    </div>
                    <button class="secondary outline small" onclick="addGlobalEnvField()">+ Add Variable</button>
                    <hr>
                    <button onclick="saveSettings()">Save Settings</button>
                </div>
            </section>
        </div>

        <div id="help" class="tab-content">
            <section>
                <h3>Help & Documentation</h3>
                <p>For detailed instructions, please refer to the <a href="https://github.com/tuannvm/mcpenetes/blob/main/docs/MANUAL.md" target="_blank">Full User Manual</a>.</p>
                <article>
                    <h4>üöÄ Getting Started</h4>
                    <p><strong>mcpenetes</strong> is your central hub for managing Model Context Protocol (MCP) servers across all your development tools.</p>
                    <ul>
                        <li><strong>Dashboard:</strong> The command center. View detected clients, configured servers, and apply your MCP setup.</li>
                        <li><strong>Search:</strong> Discover and install new MCP servers from configured registries.</li>
                        <li><strong>Clients:</strong> Define custom tools if they aren't automatically detected.</li>
                    </ul>

                    <h4>üõ†Ô∏è Managing Custom Clients</h4>
                    <p>Use the <strong>Clients</strong> tab to add support for any tool that reads a configuration file.</p>
                    <p>You'll need:</p>
                    <ul>
                        <li><strong>Config Format:</strong> Select the format the tool expects (e.g., Simple JSON <code>mcpServers</code> or VS Code style).</li>
                        <li><strong>Path:</strong> The relative path to the configuration file (e.g., <code>.config/mytool/config.json</code>).</li>
                    </ul>

                    <h4>üîç Inspecting & Debugging</h4>
                    <p><strong>Inspect Config:</strong> Click the <strong>üëÅÔ∏è</strong> icon next to a client in the Dashboard to see exactly what is being written to its config file.</p>
                    <p><strong>Inspect Server:</strong> Click <strong>üîç Inspect</strong> on a server to get the command for running the MCP Inspector on it.</p>
                    <p><strong>Logs:</strong> Use the <strong>Logs</strong> tab to view real-time application logs. You can filter by keyword or clear them if they get too noisy.</p>

                    <h4>üì¶ Registries</h4>
                    <p>Manage your sources for MCP servers in the <strong>Registries</strong> tab. You can add new URLs, edit existing ones, or remove them.</p>

                    <h4>üíæ Backups & Restoration</h4>
                    <p>Safety first! Every time you apply a configuration, a backup is created automatically.</p>
                    <ul>
                        <li><strong>Restore:</strong> Go to the <strong>Backups</strong> tab and click "Restore" on any entry to revert to that state.</li>
                        <li><strong>Cleanup:</strong> Click "Delete" to remove old backups and free up space.</li>
                    </ul>

                    <h4>üè• System Health</h4>
                    <p>Check the <strong>System</strong> tab to run the "Doctor" diagnostic tool. It checks for:</p>
                    <ul>
                        <li>Configuration file integrity</li>
                        <li>Required system dependencies (Node, Python, etc.)</li>
                        <li>Write permissions for client configuration paths</li>
                    </ul>
                </article>
            </section>
        </div>
    </main>

    <!-- Edit/Install Server Modal -->
    <dialog id="editModal">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close" onclick="closeEditModal()"></a>
                <span id="modalTitle">Edit Server Configuration</span>
            </header>
            <form id="editForm">
                <input type="hidden" id="editServerID">
                <input type="hidden" id="editMode" value="edit"> <!-- 'edit' or 'install' -->

                <div id="envFieldsContainer"></div>

                <label for="editConfigJSON">Configuration (JSON)</label>
                <textarea id="editConfigJSON" rows="10" style="font-family: monospace;"></textarea>
                <small>For installation, customize the command and arguments below. Commonly <code>npx -y package-name</code> or <code>uvx package-name</code>.</small>
            </form>
            <footer>
                <a href="#" role="button" class="secondary" onclick="closeEditModal()">Cancel</a>
                <a href="#" role="button" onclick="saveServerConfig()">Save / Install</a>
            </footer>
        </article>
    </dialog>

    <script src="/js/app.js"></script>

    <!-- Import Modal -->
    <dialog id="importModal">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close" onclick="closeImportModal()"></a>
                Import Configuration
            </header>
            <p>Paste an existing <code>mcpServers</code> JSON configuration below:</p>
            <textarea id="importJSON" rows="10" placeholder='{"mcpServers": { ... }}'></textarea>
            <footer>
                <button class="secondary outline" onclick="pasteFromClipboard()">üìã Paste from Clipboard</button>
                <button onclick="importConfig()">Import</button>
            </footer>
        </article>
    </dialog>

    <!-- Inspect Client Modal -->
    <dialog id="inspectClientModal">
        <article style="width: 80%; max-width: 1000px;">
            <header>
                <a href="#close" aria-label="Close" class="close" onclick="closeInspectClientModal()"></a>
                <span id="inspectClientTitle">Client Configuration</span>
            </header>
            <pre id="inspectClientContent" style="max-height: 600px; overflow: auto; background: #f4f4f4; padding: 1rem; font-family: monospace; font-size: 0.9rem; border-radius: 4px;"></pre>
        </article>
    </dialog>

    <dialog id="editRegistryModal">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close" onclick="closeEditRegistryModal()"></a>
                Edit Registry
            </header>
            <label>Name</label>
            <input type="text" id="editRegName" readonly>
            <label>URL</label>
            <input type="url" id="editRegUrl">
            <footer>
                <button class="secondary outline" onclick="closeEditRegistryModal()">Cancel</button>
                <button onclick="saveRegistryUpdate()">Save</button>
            </footer>
        </article>
    </dialog>

</body>
</html>
